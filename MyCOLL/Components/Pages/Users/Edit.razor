@page "/utilizadores/{Id}/roles"
@attribute [Authorize(Roles = "Admin,Gestor")]
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Identity
@using MyCOLL.Data
@using MyCOLL.Services

@inject UserAdminService Admin
@inject UserManager<ApplicationUser> UserManager
@inject AuthenticationStateProvider AuthStateProvider
@inject NavigationManager Nav

<h3>Gerir Roles</h3>

<AuthorizeView Context="auth">
    @if (model is null)
    {
        <p><em>A carregar...</em></p>
    }
    else
    {
        <p><strong>@model.Value.user.Email</strong></p>

        @if (auth.User.Identity?.Name == model.Value.user.UserName)
        {
            <!-- User editing themselves -->
            <div class="alert alert-warning mt-3">
                Não pode alterar as suas próprias permissões.
            </div>
        }
        else
        {
            <!-- Only show buttons when editing someone else -->
            @if (auth.User.IsInRole("Admin"))
            {
                <div class="d-flex gap-2 flex-wrap">
                    <button class="btn btn-outline-primary" @onclick='() => AddRole("Gestor")'>Dar Gestor</button>
                    <button class="btn btn-outline-danger" @onclick='() => AddRole("Admin")'>Dar Admin</button>
                    <button class="btn btn-outline-secondary" @onclick='() => RemoveRole("Gestor")'>Remover Gestor</button>
                    <button class="btn btn-outline-secondary" @onclick='() => RemoveRole("Admin")'>Remover Admin</button>
                </div>
            }
            else if (auth.User.IsInRole("Gestor"))
            {
                <div class="d-flex gap-2 flex-wrap">
                    <button class="btn btn-outline-primary" @onclick='() => AddRole("Fornecedor")'>Dar Fornecedor</button>
                    <button class="btn btn-outline-primary" @onclick='() => AddRole("Cliente")'>Dar Cliente</button>
                    <button class="btn btn-outline-secondary" @onclick='() => RemoveRole("Fornecedor")'>Remover Fornecedor</button>
                    <button class="btn btn-outline-secondary" @onclick='() => RemoveRole("Cliente")'>Remover Cliente</button>
                </div>
            }
        }

        <p class="mt-3">Roles atuais: @string.Join(", ", model.Value.roles)</p>
    }
</AuthorizeView>

<div class="mt-3">
    <button class="btn btn-light" @onclick='() => Nav.NavigateTo("/utilizadores")'>Voltar</button>
</div>

@code {
    [Parameter] public string Id { get; set; } = string.Empty;
    private (ApplicationUser user, IList<string> roles)? model;

    protected override async Task OnInitializedAsync()
    {
        var list = await Admin.GetAllAsync();
        model = list.FirstOrDefault(x => x.user.Id == Id);
    }

    private async Task AddRole(string role)
    {
        if (model == null) return;

        var currentUser = (await AuthStateProvider.GetAuthenticationStateAsync()).User;

        if (currentUser.Identity?.Name == model.Value.user.UserName)
            return;

        if (currentUser.IsInRole("Gestor") && (role == "Admin" || role == "Gestor"))
            return;

        if (!currentUser.IsInRole("Admin") && !currentUser.IsInRole("Gestor"))
            return;

        await UserManager.AddToRoleAsync(model.Value.user, role);
        model = (model.Value.user, await UserManager.GetRolesAsync(model.Value.user));
    }

    private async Task RemoveRole(string role)
    {
        if (model == null) return;

        var currentUser = (await AuthStateProvider.GetAuthenticationStateAsync()).User;

        if (currentUser.Identity?.Name == model.Value.user.UserName)
            return;

        await Admin.RemoveFromRoleAsync(model.Value.user.Id, role);
        await Refresh();
    }

    private async Task Refresh()
    {
        var list = await Admin.GetAllAsync();
        model = list.FirstOrDefault(x => x.user.Id == Id);
        StateHasChanged();
    }
}
