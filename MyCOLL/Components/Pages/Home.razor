@page "/"

@inject MyCOLL.Services.CategoriaService CategoriaService 
@inject MyCOLL.Services.ProdutoService ProdutoService 
@inject MyCOLL.Services.ModoEntregaService ModoEntregaService 
@inject MyCOLL.Services.LogService LogService
@using MyCOLL.Entities
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = "Admin,Gestor")]



<PageTitle>Painel de Gestão</PageTitle>

<div class="container-fluid py-4">
    <h2 class="fw-semibold mb-4">
        <i class="bi bi-speedometer2 text-primary me-2"></i>
        Painel de Gestão
    </h2>

    <!-- Dashboard cards -->
    <div class="row g-4">
        <div class="col-sm-6 col-lg-4">
            <div class="stat-card h-100">
                <div class="card-body d-flex align-items-center justify-content-between">
                    <div>
                        <h6 class="text-muted mb-1">Categorias</h6>
                        <h3 class="fw-bold mb-0">@totalCategorias</h3>
                    </div>
                    <i class="bi bi-tags text-primary fs-2"></i>
                </div>
            </div>
        </div>

        <div class="col-sm-6 col-lg-4">
            <div class="stat-card h-100">
                <div class="card-body d-flex align-items-center justify-content-between">
                    <div>
                        <h6 class="text-muted mb-1">Produtos</h6>
                        <h3 class="fw-bold mb-0">@totalProdutos</h3>
                    </div>
                    <i class="bi bi-box-seam text-success fs-2"></i>
                </div>
            </div>
        </div>

        <div class="col-sm-6 col-lg-4">
            <div class="stat-card h-100">
                <div class="card-body d-flex align-items-center justify-content-between">
                    <div>
                        <h6 class="text-muted mb-1">Modos de Entrega</h6>
                        <h3 class="fw-bold mb-0">@totalModos</h3>
                    </div>
                    <i class="bi bi-truck text-warning fs-2"></i>
                </div>
            </div>
        </div>
    </div>

    <div class="card mt-5 shadow-sm border-0 rounded-3">
        <div class="card-header bg-light fw-semibold">
            <i class="bi bi-clock-history me-2 text-primary"></i> Últimas Atualizações
        </div>
        <div class="card-body">

            @if (ultimasAtualizacoes.Count == 0)
            {
                <p class="text-muted mb-0">Sem atualizações recentes.</p>
            }
            else
            {
                <ul class="list-unstyled mb-0">
                    @foreach (var log in ultimasAtualizacoes)
                    {
                        <div class="mb-3">

                            <div>
                                <strong>@log.Tipo:</strong> @log.Acao

                                @if (!string.IsNullOrWhiteSpace(log.Nome))
                                {
                                    <span class="fw-semibold">— @log.Nome</span>
                                }
                            </div>

                            @if (!string.IsNullOrWhiteSpace(log.Descricao))
                            {
                                <div class="text-muted small">@log.Descricao</div>
                            }

                            <small class="text-muted">@log.Data.ToString("dd/MM/yyyy HH:mm")</small>
                        </div>
                    }
                </ul>
            }
        </div>
    </div>

</div>

@code {

    private int totalCategorias;
    private int totalProdutos;
    private int totalModos;

    private List<LogEntry> ultimasAtualizacoes = new();

    protected override async Task OnInitializedAsync()
    {
        var categorias = await CategoriaService.GetAllAsync();
        var produtos = await ProdutoService.GetAllAsync();
        var modos = await ModoEntregaService.GetAllAsync();

        totalCategorias = categorias?.Count ?? 0;
        totalProdutos = produtos?.Count ?? 0;
        totalModos = modos?.Count ?? 0;

        // agora usa logs reais da DB
        ultimasAtualizacoes = await LogService.GetRecent(5);
    }


}
