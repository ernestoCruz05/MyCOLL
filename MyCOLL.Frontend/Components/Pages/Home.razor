@page "/"
@using MyCOLL.UIComponents.Services
@using MyCOLL.UIComponents.Models
@using MyCOLL.UIComponents.Components
@inject CollectionApiService ApiService
@inject CartService CartService
@inject UserService UserService

<div class="rustic-theme">
    <!-- Navbar -->
    <RusticNavbar 
        OnCartToggle="ToggleCart" 
        OnLoginRequest="ShowLoginModal" 
        OnSearch="HandleSearch"
        OnHomeClick="ResetView" />

    <!-- Category Slider -->
    @if (categories != null && categories.Any())
    {
        <CategorySlider 
            Categories="categories" 
            SelectedCategoryId="selectedCategoryId" 
            OnCategorySelected="FilterByCategory" />
    }

    <!-- Hero Banner (shown on home view) -->
    @if (string.IsNullOrEmpty(searchTerm) && selectedCategoryId == null)
    {
        <div class="hero-banner">
            <div class="hero-content">
                <h1 class="hero-title">
                    <i class="fas fa-scroll"></i> Discover Rare Artifacts
                </h1>
                <p class="hero-subtitle">
                    Explore our curated collection of historical treasures, 
                    vintage memorabilia, and unique collectibles from around the world.
                </p>
            </div>
        </div>
    }

    <!-- Main Content -->
    <div class="main-content">
        <!-- Section Header -->
        <div class="section-header">
            <h2 class="section-title">
                @if (!string.IsNullOrEmpty(searchTerm))
                {
                    <i class="fas fa-search"></i>
                    <span>Search Results: "@searchTerm"</span>
                }
                else if (selectedCategoryId != null)
                {
                    <i class="fas fa-tag"></i>
                    <span>@GetSelectedCategoryName()</span>
                }
                else
                {
                    <i class="fas fa-gem"></i>
                    <span>Featured Collection</span>
                }
            </h2>
            @if (products != null)
            {
                <span class="product-count">@products.Count artifact(s) found</span>
            }
        </div>

        <!-- Product Grid -->
        @if (isLoading)
        {
            <div class="loading-container">
                <div class="loading-spinner"></div>
                <p class="loading-text">Discovering artifacts...</p>
            </div>
        }
        else if (products == null || !products.Any())
        {
            <div class="empty-state">
                <i class="fas fa-box-open"></i>
                <h4>No artifacts found</h4>
                <p>Try adjusting your search or browse different categories</p>
            </div>
        }
        else
        {
            <div class="product-grid">
                @foreach (var item in products)
                {
                    <ProductCard 
                        Product="item" 
                        OnInspect="InspectProduct" 
                        OnAddToCart="HandleAddToCart" />
                }
            </div>
        }
    </div>

    <!-- Decorative Border -->
    <div class="decorative-border"></div>
</div>

<!-- Cart Drawer -->
<CartDrawer 
    IsOpen="isCartOpen" 
    OnClose="CloseCart" 
    OnCheckout="HandleCheckout" />

<!-- Product Detail Modal -->
<ProductDetailModal 
    Product="selectedProduct" 
    CategoryName="@GetCategoryName(selectedProduct?.CategoriaId)"
    IsVisible="isModalOpen" 
    OnClose="CloseModal" 
    OnAddToCart="HandleModalAddToCart" />

<!-- Toast Notification -->
@if (showToast)
{
    <div class="toast-notification">
        <i class="fas fa-check-circle"></i>
        <span>@toastMessage</span>
    </div>
}

@code {
    // Data
    private List<Produto>? products;
    private List<Categoria>? categories;
    
    // State
    private bool isLoading = true;
    private bool isCartOpen = false;
    private bool isModalOpen = false;
    private Produto? selectedProduct;
    private int? selectedCategoryId = null;
    private string searchTerm = string.Empty;
    
    // Toast
    private bool showToast = false;
    private string toastMessage = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadInitialData();
    }

    private async Task LoadInitialData()
    {
        isLoading = true;
        StateHasChanged();

        try
        {
            // Load categories and products in parallel
            var categoriesTask = ApiService.GetCategoriesAsync();
            var productsTask = ApiService.GetProductsAsync();

            await Task.WhenAll(categoriesTask, productsTask);

            categories = await categoriesTask;
            products = await productsTask;
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading data: {ex.Message}");
            products = new List<Produto>();
            categories = new List<Categoria>();
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task FilterByCategory(int? categoryId)
    {
        selectedCategoryId = categoryId;
        searchTerm = string.Empty;
        isLoading = true;
        StateHasChanged();

        try
        {
            products = await ApiService.GetProductsAsync(categoryId);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error filtering: {ex.Message}");
            products = new List<Produto>();
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task HandleSearch(string term)
    {
        searchTerm = term;
        selectedCategoryId = null;
        
        if (string.IsNullOrWhiteSpace(term))
        {
            await LoadInitialData();
            return;
        }

        isLoading = true;
        StateHasChanged();

        try
        {
            products = await ApiService.SearchProductsAsync(term);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error searching: {ex.Message}");
            products = new List<Produto>();
        }
        finally
        {
            isLoading = false;
            StateHasChanged();
        }
    }

    private async Task ResetView()
    {
        searchTerm = string.Empty;
        selectedCategoryId = null;
        await LoadInitialData();
    }

    private void InspectProduct(Produto product)
    {
        selectedProduct = product;
        isModalOpen = true;
        StateHasChanged();
    }

    private void CloseModal()
    {
        isModalOpen = false;
        selectedProduct = null;
        StateHasChanged();
    }

    private void HandleAddToCart(Produto product)
    {
        ShowToast($"Added '{product.Nome}' to cart");
    }

    private void HandleModalAddToCart((Produto product, int quantity) args)
    {
        ShowToast($"Added {args.quantity}x '{args.product.Nome}' to cart");
    }

    private void ToggleCart()
    {
        isCartOpen = !isCartOpen;
        StateHasChanged();
    }

    private void CloseCart()
    {
        isCartOpen = false;
        StateHasChanged();
    }

    private void HandleCheckout()
    {
        if (!UserService.IsLoggedIn)
        {
            ShowLoginModal();
            ShowToast("Please login to checkout");
            return;
        }

        // Navigate to checkout or show checkout modal
        ShowToast("Proceeding to checkout...");
        CloseCart();
    }

    private void ShowLoginModal()
    {
        // This would trigger a login modal
        ShowToast("Login functionality coming soon!");
    }

    private string GetSelectedCategoryName()
    {
        if (selectedCategoryId == null || categories == null) 
            return "All Collections";
        
        return categories.FirstOrDefault(c => c.Id == selectedCategoryId)?.Nome ?? "Category";
    }

    private string? GetCategoryName(int? categoryId)
    {
        if (categoryId == null || categories == null) return null;
        return categories.FirstOrDefault(c => c.Id == categoryId)?.Nome;
    }

    private async void ShowToast(string message)
    {
        toastMessage = message;
        showToast = true;
        StateHasChanged();

        await Task.Delay(3000);
        showToast = false;
        StateHasChanged();
    }
}